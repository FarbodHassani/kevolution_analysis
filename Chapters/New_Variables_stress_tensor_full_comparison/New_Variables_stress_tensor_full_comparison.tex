%\documentclass[a4paper,12pt]{article}
%%% My standard included packages
%%\pdfoutput=1 % if your are submitting a pdflatex (i.e. if you have
%%             % images in pdf, png or jpg format)
%%\usepackage{jcappub} % for details on the use of the package, please
%%                     % see the JCAP-author-manual
%%\usepackage[T1]{fontenc} % if needed
%
%\usepackage{setspace}           % Allows easy changes to line spacing 
%\usepackage{graphicx}           % Allows including of graphics files
%\usepackage{amsmath}            % Additional math capabilities
%\usepackage{marginnote}         % Used with todonotes package
%\usepackage{datetime}           % Allows formatting of date and time
%\newcommand {\be}{\begin{equation}}
%\newcommand {\ee}{\end{equation}}
%
%\usepackage{empheq}
%\usepackage{cancel}
%\usepackage{etoolbox}
%
%
%\usepackage{enumitem} 
%\usepackage{color}
%%Mathematica colors
%\definecolor{identifiercolor}{rgb}{.4,.6,.56}
%\definecolor{stringcolor}{gray}{0.5}
%\definecolor{inactivecolor}{rgb}{0.15,0.15,0.5}
%\usepackage{listings}
%%Mathematica
%\usepackage{listings}
%\lstset{basicstyle={\footnotesize\def\fvm@Scale{.85}\fontfamily{fvm}\selectfont},
%  breaklines=true,
%  escapeinside={\%*}{*)},
%  keywordstyle={\bfseries\color{inactivecolor}},
%  stringstyle={\bfseries\color{stringcolor}},
%  identifierstyle={\bfseries\color{identifiercolor}},
%  language=Mathematica,
%  otherkeywords={DiscretizeRegion},
%  showstringspaces=false}
%\renewcommand{\lstlistingname}{Listing}
%
%
%
%
%\usepackage{amsmath}
%\usepackage{graphicx}% Use pdf, png, jpg, or epså¤ with pdflatex; use eps in DVI mode
%\usepackage{caption}
%\usepackage{subcaption}
%          % List formatting commands
%\setlist{noitemsep}             % Remove space between list items 
%%\usepackage{subfigure}          % Create numbered and captioned subfigures
%\usepackage{rotating}           % Create landscape tables and figures
%\usepackage[dvipsnames]{xcolor} % Refer to colors by name
%\usepackage[colorlinks=true,urlcolor=blue,linkcolor=Orange,citecolor=RedViolet]{hyperref}           % URLS and hyperlinks
%%\usepackage{hyperref}           % URLS and hyperlinks
%\usepackage{float}              % Activate [H] option to place figure HERE
%\usepackage[numbers]{natbib}
%\usepackage{versionPO}          % Include text conditionally
%\usepackage{caption}
%%\usepackage[utf8]{inputenc}
%%\usepackage[nottoc]{tocbibind}
%\lstset{basicstyle=\ttfamily,
%  showstringspaces=false,
%  commentstyle=\color{red},
%  keywordstyle=\color{blue}
%}
%% These next lines allow including or excluding different versions of text
%% using versionPO.sty
%\includeversion{notes}		% Include notes?
%%\excludeversion{notes}
%\excludeversion{comment}
%\includeversion{links}          % Turn hyperlinks on?
%\excludeversion{submit}		% Format for conference submission?
%\includeversion{toc}		% Include table of contents?
%%\graphicspath{{./Results1-Perihelionadvance}}
%
%% Turn off hyperlinking if links is excluded
%\iflinks{}{\hypersetup{draft=true}}
%
%% Notes options
%\ifnotes{%
%\usepackage[margin=1in,paperwidth=10in,right=2.5in]{geometry}%
%\usepackage[textwidth=1.4in,shadow,colorinlistoftodos]{todonotes}%
%}{%
%\usepackage[margin=1in]{geometry}%
%\usepackage[disable]{todonotes}%
%}
%
%% Allow todonotes inside footnotes without blowing up LaTeX
%% Next command works but now notes can overlap. Instead, we'll define 
%% a special footnote note command that performs this redefinition.
%%\renewcommand{\marginpar}{\marginnote}%
%
%% Save original definition of \marginpar
%\let\oldmarginpar\marginpar
%% Workaround for todonotes problem with natbib (To Do list title comes out wrong)
%\makeatletter\let\chapter\@undefined\makeatother % Undefine \chapter for todonotes
%% Packages included specifically for this document.
%\usepackage{texintro}           % Document-specific definitions
%\usepackage{tocvsec2}           % More flexible formatting of table of contents
%\usepackage{bibentry}           % Print full citation in text
%\nobibliography*                                % Allow use of \bibentry command
%\usepackage{tikz}             % Already included by todonotes
%\usetikzlibrary{matrix}
%\usepackage[retainorgcmds]{IEEEtrantools}  % Equation formatting. Option needed to
%                                           % allow enumitem to work.
%
%% Workaround for todonotes problem with natbib (To Do list title comes out wrong)
%% If you're including tocvsec2, do so before this command.
%\makeatletter\let\chapter\@undefined\makeatother % Undefine \chapter for todonotes.
%
%% Number paragraphs and subparagraphs and include them in TOC
%%\setcounter{tocdepth}{2}
%
%\usepackage[affil-it]{authblk} 
%\usepackage{etoolbox}
%\usepackage{titlesec}
%
%\setcounter{secnumdepth}{4}
%
%\titleformat{\paragraph}
%{\normalfont\normalsize\bfseries}{\theparagraph}{1em}{}
%\titlespacing*{\paragraph}
%{0pt}{3.25ex plus 1ex minus .2ex}{1.5ex plus .2ex}
%
%
%\def\be{\begin{equation}}
%\def\ee{\end{equation}}
%\def\bea{\begin{eqnarray}}
%\def\eea{\end{eqnarray}}
%\def\bean{\begin{eqnarray*}}
%\def\eean{\end{eqnarray*}}
%\def\cd{\cdot}
%\def\vp{\varphi}
%\def\l {\langle}
%\def\re {\rangle}
%\def \dd {\partial}
%\def \ra {\rightarrow}
%\def \la {\lambda}
%\def \La {\Lambda}
%\def \De {\Delta}
%\def \DH {\Delta_{\rm HI}}
%\newcommand{\de}{\delta}
%\def \b {\beta}
%\def \al {\alpha}
%\def \ka {\kappa}
%\def \Ga {\Gamma}
%\def \ga {\gamma}
%\def \si {\sigma}
%\def \Si {\Sigma}
%\def \ep {\epsilon}
%\def \om {\omega}
%\def \Om {\Omega}
%\def \lap {\triangle}
%\def \ep {\epsilon}
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%Special definitions for this paper
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%\newcommand{\MyRed}{\color [rgb]{0.8,0,0}}
%\newcommand{\MyGreen}{\color [rgb]{0,0.7,0}}
%\newcommand{\MyBlue}{\color [rgb]{0,0,0.8}}
%\newcommand{\MyBrown}{\color [rgb]{0.8,0.4,0.1}}
%\newcommand{\MyPurple}{\color [rgb]{0.6,0.0,0.6}}
%\def\GV#1{{\MyRed [GV: #1]}}
%\def\RD#1{{\MyGreen [RD:  {\tt #1}]}} 
%\def\RDt#1{{\MyGreen #1}}   
%\def\GM#1{{\MyBlue [GM: #1]}}  
%\def\GF#1{{\MyPurple [GF: #1]}}    
%
%
%
%\newcommand{\ie}{\emph{i. e.}}
%\newcommand{\cf}{\emph{cf.}}
%\newcommand{\etal}{\emph{et al.}\xspace}
%\newcommand{\eg}{\emph{e. g.}}
%
%\newcommand{\Scal}{\mathcal S}
%\newcommand{\DD}{\mathcal D}
%\newcommand{\EE}{\mathcal E}
%\newcommand{\MM}{\mathcal M}
%\newcommand{\HH}{\mathcal H}
%
%\newcommand{\Real}{\mathbb{R}}
%\newcommand{\bn}{\boldsymbol{n}}
%\newcommand{\bv}{\boldsymbol{v}}
%\newcommand{\bx}{\boldsymbol{x}}
%\newcommand{\bnabla}{\boldsymbol{\nabla}}
%\newcommand{\bell}{\boldsymbol{\ell}}
%\newcommand{\bal}{\boldsymbol{\alpha}}
%
%
%
%
%
%%\usepackage{lmodern}
%%\renewcommand\Authfont{\fontsize{12}{14.4}\selectfont}
%%\renewcommand\Affilfont{\fontsize{9}{10.8}\itshape}
%%\renewcommand\Authfont{\fontsize{12}{15}\selectfont}
%%\renewcommand\Affilfont{\fontsize{9}{11}\itshape}
%\definecolor{astral}{RGB}{46,116,181}
%%\subsectionfont{\color{astral}}
%%\sectionfont{\color{astral}}
%%\usdate{17 May}                         % Use usual LaTeX date layout
%
%%\title{\color{BlueViolet}\Huge{On the accuracy of approximated geodesic equations and different potentials with different numerical methods } }
%\title{\color{BlueViolet}\Huge{Just part of projects which should be added to the original version}}
%%\vskip 2em
%\author{Farbod Hassani}
%%\thanks{Email:\href{mailto:farbod.hassani@unige.ch}{{farbod.hassani@unige.ch}}}  \thanks{Homepage: \href{http://www.farbod-hassani.com}{farbod-hassani.com}}}
%%\affil{D\'epartement de Physique Th\'eorique and Center for Astroparticle Physics, Universit\'e de Gen\'eve,
%%24 quai Ansermet, CH-1211 Gen\'eve 4, Switzerland}
%
%%{farbod-hassani.com}} }
%%\newcommand*{\TitleFont}{%     \usefont{\encodingdefault}{\rmdefault}{b}'%     \fontsize{18}{16}%    \selectfont}
%%\title{\TitleFont Halo finder}
%%\author[1]{{Farbod Hassani} \thanks{ \url{farbod.hassani@gmail.com}
%%}
%%\thanks{farbod-hassani.com}}
%%\author[2]{Author E\thanks{E.E@university.edu}}
%%\affil[1]{D\'epartement de Physique Th\'eorique and Center for Astroparticle Physics, Universit\'e de Gen\'eve,
%%24 quai Ansermet, CH-1211 Gen\'eve 4, Switzerland}
%%\emailAdd{farbod.hassani@gmail.com}
%%\affil[2]{Department of Mechanical Engineering, \LaTeX\ University}
%      %\begin{abstract}
%%This is abstract text: This simple document shows very basic features of \LaTeX{}.
%%\lstset { %
%%    language=C++,
%%    %backgroundcolor=\color{black!5}, % set backgroundcolor
%%    basicstyle=\footnotesize,% basic font settings
%%}
%\begin{document}
 \section{$\delta$ comparison}
 \subsection{Without sourcing total stress tensor }
 Here to check we are writing the true stress tensor, we compare the Gevolution with mathematica result and we turn on the kessence source gravity flag but keep in mind that since we use new set of variables, the gravitational potentials are not appeared on the stress tensor since we have gravitational potential hidden on the $\zeta$! \\
So we can easily check Gevolution versus mathematica to just check that the power of Stress tensor is correctly produced, while we already know that it must be correct since we have checked all the variables including like $\pi$, $\zeta$ and $\mathcal{H}$ so it is kind of making sure that the effect of kessence stress tensor on the total stress tensor is taken into account correctly and plus it is written in the output text rightly.\\
So we are going to do is first turn off the effect of kessence stress tensor on the total stress tensor and check just the kessence stress tensor is written correctly and is compared with the error we expect. In terms of new variables the stress tensor reads,
\begin{align}
 & T_0^0 (Gev)=  \Omega^0_{kess} a^{-3 w}  \Bigg[1+ \frac{1+w}{c_s^2} \Big(- 3 \mathcal{H}c_s^2 \pi +\zeta     \Big )   \Bigg ]
\nonumber \\ &
T^{i}_{0}(Gev)= - \Omega^0_{kess} a^{-3 w} (1+w) \partial _i \pi 
\nonumber \\ &
T_{j}^{i}(Gev)= w  \, \Omega^0_{kess} a^{-3 w} \Bigg [ 1+  \frac{1+w}{w}\Big ( -3 \mathcal{H} w  \pi+ \zeta \Big) \delta_{j}^{i}   \Bigg]
\end{align}
So the $\delta_{kess} = \frac{1+w}{c_s^2} \Big(- 3 \mathcal{H}c_s^2 \pi +\zeta     \Big ) $ which now we want to compare between Gevolution and mathematica solution for when this stress tensor does not contribute to the total stress tensor in Gevolution which is what we are able to catch in mathematica!
 \\
 The technical part of mathematica script would be,
  \begin{lstlisting}[language=Mathematica, basicstyle=\tiny]
  GevPowerDataz100 = 
  Table[{datapiGev100[[l, 1]], GevFieldz100[[l]], Gevzetaz100[[l]],  GevDeltaz100[[l]]}, {l, 1, Dimensions[GevFieldz100][[1]]}];
  MatSolz100 = 
  Table[{GevPowerDataz100[[k, 1]], Abs[Agrex[[k]][[1, 2]][[1]]],  Abs[Agrex[[k]][[1, 3]][[1]]],  Abs[(1 + w)/ cs^2 (-3 cs^2 Agrex[[k]][[1, 2]][[1]] 
  +  Agrex[[k]][[1, 3]][[1]]  )]}, {k, 1, kmax}]; (*Last column is delta computed*)
  Error\[Delta]10 = Table[{MatSolz10[[k, 1]],  Abs[(Abs[MatSolz10[[k, 4]]] - GevPowerDataz10[[k, 4]])]/
     GevPowerDataz10[[k, 4]]}, {k, 1, kmax}] // N;
  \end{lstlisting}
       After  tracking the $\delta$ in mathematica and Gevolution we get the result in the below,
       \begin{figure}[H]
 \includegraphics[scale=0.3]{delta_sol_01} 
 \end{figure}
  \subsection{Kessence sourcing total stress tensor }
  Now what happens if we let also the stress tensor of kessence contribute in the total stress energy tensor? That is a important check which shows that the stress tensor is added in Gevolution correctly, since from previous experience we know that if we add it with wrong coefficients the particles speed up and go over cpus! Again we have the same stress tensor for the kessence but this time we add the components to the total stress tensor as following,
    \begin{lstlisting}[language=c++, basicstyle=\tiny]
if (sim.Kess_source_gravity==1)
{
// Kessence projection Tmunu
 	if (sim.vector_flag == VECTOR_ELLIPTIC)
		{
			projection_Tmunu_kessence( T00_Kess,T0i_Kess,Tij_Kess, dx, a, phi, phi_old, 	chi, pi_k, zeta_integer, cosmo.Omega_kessence, cosmo.w_kessence, 	cosmo.cs2_kessence, Hconf(a, fourpiG, cosmo), fourpiG, 1 );
		}
 	else
		{
			projection_Tmunu_kessence( T00_Kess,T0i_Kess,Tij_Kess, dx, a, phi, phi_old, 	chi, pi_k, zeta_integer, cosmo.Omega_kessence, cosmo.w_kessence, 	cosmo.cs2_kessence, Hconf(a, fourpiG, cosmo), fourpiG, 0 );
		}

		for (x.first(); x.test(); x.next())
		{
			// The coefficient is because it wanted to to be source according to eq C.2 of Gevolution paper
			// Note that it is multiplied to dx^2 and is divived by -a^3 because of definition of T00 which is scaled by a^3
			// We have T00 and Tij according to code's units, but source is important to calculate potentials and moving particles.
			// There is coefficient between Tij and Sij as source.
			source(x) += (fourpiG * dx * dx / a) * T00_Kess(x);
			if (sim.vector_flag == VECTOR_ELLIPTIC)for(int 	c=0;c<3;c++)Bi(x,c)+= (2. * fourpiG * dx * dx / a) * T0i_Kess(x,c);
			for(int c=0;c<6;c++)Sij(x,c)+=(2. * fourpiG * dx * dx / a) * Tij_Kess(x,c);
		}
}
#ifdef BENCHMARK
		kessence_update_time += MPI_Wtime() - ref_time;
		ref_time = MPI_Wtime();
#endif
// Kessence projection Tmunu end\end{lstlisting}
It is clear that we should not get the different solution since we have turned off the effect of potentials on the scalar field, also the below plots show nothing changes in this case, but still was a good check that at least we did not make a bad mistake at coefficients which otherwise it had blown up.
       \begin{figure}[H]
 \includegraphics[scale=0.3]{delta_source_on_01} 
 \end{figure}
        \begin{figure}[H]
 \includegraphics[scale=0.3]{Field_source_on_01} 
 \end{figure}
   \section{Solving the full equation with potentials}
   \subsection{Field dynamics, Kessence stress tensor is turned off }
Here we try to compare mathematica with Gevolution in scalar fields solution when the gravitational potentials are turned off and kessence does not source gravity. The set of equations are as following,
  \begin{align} 
 &{ \zeta'=  3 \mathcal{H}(w \zeta +c_s^2 \Psi) -c_s^2  ({ 3 \mathcal{H}^2 - 3 \mathcal{H}' }) \pi + 3 c_s^2 \Phi'  +c_s^2 \nabla^2 \pi }
  \end{align} 
  \be
  \pi'=\zeta-\mathcal{H} \pi +\Psi
  \ee
  Now in mathematica we provide $\Phi$ and $\Psi'$ from the Gevolution, but we take them as a constant in time, then we solve the full equations and compare with Gevolution. Using the leap frog method as following (like before) we have,
  \subsubsection{$\pi$ equation}
 for the $\pi$ equation we have,
    \be
      \pi_{n+1}=\pi_{n} + \pi'_{n+\frac{1}{2}} \Delta \tau
    \ee
     \be
  \pi'_{n+\frac{1}{2}}=\zeta_{n+\frac{1}{2}}  -\mathcal{H}_{n+\frac{1}{2}}  \pi_{n+\frac{1}{2}}  +\Psi_{n+\frac{1}{2}} 
      \ee
      For the background part it is better to update background before this step to have $a_{kess}$ at (n+1/2) and then having $\mathcal{H}(n+1/2)$
      Just note that making $\zeta$ updating at half steps help us because we need all the terms at integer steps. \\
      Since the scalar field Stress energy tensor must be synchronized with particles stress tensor, we need to have all the variables at the same step which is $n$, so we need to write all the terms at step ${n+\frac{1}{2}} $ in terms of the values at step $n$ and $n+1$ as following, of course except $\zeta$ which we have it at $n+1/2$. The easiest model to calculate $F_{{n+\frac{1}{2}} }$ is by taking average of the next and last step, so
     \be
     \pi_{n+\frac{1}{2}} = \frac{ \pi_{n+1} + \pi_{n} }{2 }
     \ee
     and the same for all the other variables at step ${n+\frac{1}{2}}$. 
     
     For $\pi$ we have,
     \be
      \pi_{n+1}= \pi_{n} + \Delta  \tau \Big [  \zeta_{n+\frac{1}{2}}   -\mathcal{H}_{n+\frac{1}{2}}  ( \frac{ \pi_{n+1} + \pi_{n} }{2 })  +\Psi_{n+\frac{1}{2}} \Big ]
     \ee
         \be
      \pi_{n+1}=  \frac{1}{1+ \mathcal{H}_{n+\frac{1}{2}} \Delta \tau/2}\Bigg[ \pi_{n} + \Delta \tau \Big [  \zeta_{n+\frac{1}{2}}   -\mathcal{H}_{n+\frac{1}{2}}   \frac{  \pi_{n} }{2 } +\Psi_{n+\frac{1}{2}}  \Big ] \Bigg]
     \ee
   As it is clear from the formula we don't have access to the $\Psi_{n+\frac{1}{2}} $, so we use the extrapolation  to have them in next half steps,
   \begin{align}
      \Psi_{n+\frac{1}{2}} = \Psi_{n} + \Psi'_{n} \frac{d \tau}{2} 
   \end{align} 

   Moreover to have $\Psi'_{n}$ we must use the following formula by saving $\Psi$ at two different steps!
   \be
   \Psi'_{n} = \frac{\Psi_{n} - \Psi_{n-1} }{d \tau}
   \ee

 \subsubsection{$\zeta$ equation}
  \be
  \zeta_{n+\frac{3}{2}}=\zeta_{n+\frac{1}{2}} + \zeta'_{n+1} \Delta \tau
  \ee
  where $ \zeta'_{n+1}$ reads from the differential equation as following,
  \be
  \zeta'_{n+1}=3 \mathcal{H}_{n+1}(w \zeta_{n+1} +c_s^2 \Psi_{n+1}) -c_s^2(   3 \mathcal{H}^2_{n+1} 
  - 3 \mathcal{H}' _{n+1}) \pi_{n+1}+ 3 c_s^2 \Phi'_{n+1}  +c_s^2 \nabla^2 \pi_{n+1}
    \ee
    Since we need to have $\zeta_{n+1}$ at $\zeta'_{n+1}$ so we write $\zeta_{n+1} = \frac{\zeta_{n+3/2} + \zeta_{n+1/2} }{2}$ \\ 
    We get,
      \be
  \zeta_{n+\frac{3}{2}}=\zeta_{n+\frac{1}{2}} +  \Delta \tau \Bigg [3 \mathcal{H}_{n+1}(w\frac{\zeta_{n+\frac{3}{2}} + \zeta_{n+\frac{1}{2}} }{2} +c_s^2 \Psi_{n+1}) -c_s^2(   3 \mathcal{H}^2_{n+1} 
  - 3 \mathcal{H}' _{n+1}) \pi_{n+1}+ 3 c_s^2 \Phi'_{n+1}  +c_s^2 \nabla^2 \pi_{n+1} \Bigg] 
  \ee
  Simplifying the expression gives,
  \be
   \zeta_{n+\frac{3}{2}}= \frac{1}{1-  3   \mathcal{H}_{n+1} w \Delta \tau/2 } \Bigg[ \zeta_{n+\frac{1}{2}} +  \Delta \tau \Bigg( 3 \mathcal{H}_{n+1}\Big( \frac{ w\zeta_{n+\frac{1}{2}} }{2} +c_s^2 \Psi_{n+1} \Big)  -c_s^2(   3 \mathcal{H}^2_{n+1} 
  - 3 \mathcal{H}' _{n+1}) \pi_{n+1}+ 3 c_s^2 \Phi'_{n+1}  +c_s^2 \nabla^2 \pi_{n+1} \Bigg) \Bigg]
  \ee
It is very important to check everything for the first loop specifically! For the first loop we have $\zeta^{(0)}$, $\zeta^{(-1/2)}$ is computed from the values at step 0 and then $\zeta$ is updated to have $\zeta^{(1/2)}$ from the values of $\Psi^{(0)}$ but we take $\Phi'^{(0)}=0$ which is an approximation in our scheme. Then we update $\pi$ to have it at step 1 and then we update $\zeta$ to have it at step $3/2$ during all of these procedures, $\Phi$ is assumed to be constant and we use $\Phi^{(1/2)}= \Phi^{(0)}$ since in the first loop $\Phi'$ is zero! So this is an approximation that in the first loop we take $\Psi'=0 $ and use the same $\Phi$ at 1/2 and 0 step the same. But in the other loops everything seems correct as following,
\be
\zeta^{n+1/2}, \zeta^{n}, \pi^{n},  \Psi^{n},  \Psi'^{n}   \longrightarrow  a_{kess}^{n+1/2}, \Psi^{n+1/2}, \zeta^{n+1/2},  \pi^{n+1}  \longrightarrow a_{kess}^{n+1},\pi^{n+1}, \Psi^{n+1},     \zeta^{n+3/2}.  
\ee
\large{{\color{Blue}Approximations:}}\\
{\color{red} The important approximations here are:\\
1- At the first loop we take $\Phi'=0$\\
2- The value of $\Phi^{(n+1)} = \Phi^{(n)} + \Phi '^{(n)} \times d \tau  $ to compute $\zeta^{n+3/2}$ which again at the first loop we assume $\Phi^{(1)} = \Phi^{(0) }$\\
3- Since we do not have $\Phi^{'(n+1)}$ we assume that it does not change fast, so we take $\Phi^{'(n+1)} = \Phi'^{(n) }$ or equivalently $\Phi''^{(n)} \approx 0$ \\
All the top approximations can be suppressed by increasing the number of kessence update or decreasing the time stepping of Gevolution.
}
\\
Some important point in the Gevolution might be in the Gevolution.hpp 
    \begin{lstlisting}[language=c++, basicstyle=\tiny]
    
    	template <class FieldType>
			void update_pi_k( double dtau, double dx,double a, Field<FieldType> & phi, Field<FieldType> & phi_old, Field<FieldType> & chi,Field<FieldType> & chi_old, Field<FieldType> & pi_k, Field<FieldType> &,  Field<FieldType> & zeta_half , double Omega_fld ,double w, double cs2, double Hcon, double  H_prime)
			{
        double psi, psi_prime, psi_half;
        // WRONG! double H_half= Hcon + H_prime *  dtau/2. ; // H(n+1/2) = H(n) + H'(n) dtau/2 WRONG!
        //We do not need to write the top equation, since we already have H(n+1/2) by updating the background by half step.
        //Hcon is at (n+1/2)
        double Coeff1 = 1./(1. + Hcon * dtau/2.);

			  Site x(phi.lattice());
			  for (x.first(); x.test(); x.next())
			    {
            psi=phi(x) - chi(x);
            psi_prime= ((phi(x) - chi(x))-(phi_old(x) - chi_old(x)))/dtau;
            psi_half= psi + psi_prime * dtau/2.; //psi_half (n+1/2) = psi(n) + psi_prime'(n) dtau/2

            //*****
            //LINEAR EQUATION:
            //*****
            pi_k(x)=Coeff1 * (pi_k(x)  + dtau * ( zeta_half(x) - Hcon * pi_k(x)/2. + psi_half ) ); //  pi_k(n+1)
            //*****
            //LINEAR EQUATION:
            //*****

            //Full equation
            //pi_k(n+1) = Coeff1 * (pi_k(n) + \Delta T (zeta(n+1/2) + ... ))
			      // pi_k(x)=Coeff1 * (pi_k(x)  + dtau * ( zeta_half(x) - Hcon * pi_k(x)/2. + psi_half ) ); //  pi_k(n+1)


            //NOTE: zeta and psi must be at n+1/2 step according to the formula! So we need to update zeta first in the main loop.
			    }
			}
	template <class FieldType>
			void update_zeta(double dtau, double dx,double a, Field<FieldType> & phi, Field<FieldType> & phi_old, Field<FieldType> & chi,Field<FieldType> & chi_old, Field<FieldType> & pi_k, Field<FieldType> & zeta_half , Field<FieldType> & zeta_integer, double Omega_fld ,double w, double cs2, double Hcon, double H_prime )
			{
			  double CoeffI, CoeffII, psi, psi_old, psi_prime, phi_prime, Laplacian_pi, zeta_old_half ;
        //Hcon(n+1)to calculate zeta(n+1/2)
        CoeffI = 1./(1. -  3. * Hcon * w  * dtau/2. );
        //Since a_kess is at (n+1) so H_prime is at (n+1) which is needed to calculate zeta(n+1/2)
        CoeffII = cs2 * (3. * Hcon * Hcon - 3. * H_prime );

				Site x(phi.lattice());
				for (x.first(); x.test(); x.next())
					{
            //Everything here is at step n except zeta which is at half steps! zeta is like pi_v
						Laplacian_pi= pi_k(x-0) + pi_k(x+0) - 2. * pi_k(x);
						Laplacian_pi+=pi_k(x+1) + pi_k(x-1) - 2. * pi_k(x);
						Laplacian_pi+=pi_k(x+2) + pi_k(x-2) - 2. * pi_k(x);
            Laplacian_pi= Laplacian_pi/(dx*dx);
						psi=phi(x) - chi(x); //psi(n)
						// psi_prime= ((phi(x) - chi(x))-(phi_old(x) - chi_old(x)))/dtau; //psi_prime(n)
					  phi_prime= (phi(x) - phi_old(x))/dtau; //phi_prime(n+1) since we want to use it to compute zeta (n+3/2)
            //NOTE: We dont have phi'(n+1) since it will be updated by particles later, but we ***ASSUME** it remains contant and phi_prime(n) = phi_prime(n+1) or take the second derivative for this period approximately to zero!
            psi_prime= ((phi(x) - chi(x))-(phi_old(x) - chi_old(x)))/dtau;
            psi = psi + psi_prime * dtau; //psi(n+1) = psi(n) + psi'(n) dtau
            //***************
            //Linear equation
            //***************
            //Scalar Field only equation:
            zeta_old_half=zeta_half(x); // zeta(n+1/2)
            zeta_half(x)= CoeffI * ( zeta_half(x) + dtau * ( 3. * Hcon * ( w * zeta_half(x)/2. + cs2 * psi ) - CoeffII * pi_k(x) + 3. * cs2 * phi_prime + cs2 * Laplacian_pi) ); // zeta(n+3/2) from zeta(n+1/2) and zeta'(n+1) so we need to have Phi^{n+1} and Phi'{n+1} which we approximate both!
            //***************
            //Linear equation
            //***************
            // computing zeta (n) by taking average ove zeta(n+1/2) and zeta(n-1/2)
            zeta_integer(x)= (zeta_half(x) + zeta_old_half)/2.; //zeta(n+1)
            }
 \end{lstlisting}
 Also the important point in mathematica is adding $\Phi$ and $\Phi'$ as the initial condition from Gevolution as following,
  \begin{figure}[H]
 \includegraphics[scale=0.5]{Mathematica_phi_phiprime} 
 \end{figure}
Again providing the initial condition from Gevolution at z=100 and looking at evolution up to z=10 while $\Phi$ and $\Phi'$ is provided by Gevolution at redshift 100 and is taken constant, we get,
  \begin{figure}[H]
 \includegraphics[scale=0.5]{SolveFull-Mathematica_01} 
 \end{figure}
 The result is acceptable, but we know that if we increase kessence number of update we improve the approximations and also we see that the difference is more in high wavenumbers which is probably the effect of being near Nyqvist frequency, so we guess we can improve it by increasing number of grids. Moreover the relative error could be because of the fact that we do not solve extra differential equation for $\Phi$ and naively we take it independent of $\Phi'$ and both as a constant. \\
 Now we want to test if we add an extra differential equation in mathematica as $\Phi'=const$, where the constant is the value of $\Phi'$ in each redshift and the initial condition of $\Phi$ reads from Gevolution, whether we improve the relative error?\\
 The technical points in mahtematica are as following which is change the time variable in $\Phi$ and $\Psi$
   \begin{figure}[H]
 \includegraphics[scale=0.5]{mathe_points_01} 
 \end{figure}
    \begin{figure}[H]
 \includegraphics[scale=0.5]{mathe_points_02} 
 \end{figure}
And the result is,
  \begin{figure}[H]
 \includegraphics[scale=0.5]{SolveFull-Mathematica_02} 
 \end{figure}
Compared with previous plot we see no difference and the conclusion is that the change of $\Phi$ or $\Psi$ during different redshifts based on $\Phi'$ does not have so much affect on the $\zeta$ and $\mathcal{H} \pi$, on $\zeta$ it is clear since the effect of potentials is suppressed with the $c_s^2$ factor, but on $\pi$ it has a direct effect, but it seems it is suppressed compared with other terms in equation!\\
Lets check the improvements by increasing precision parameters, like number of grid and step size.  So for a biggest possible number of grids in local computer, 256 and kessence number of update=15 we get the below figure
  \begin{figure}[H]
 \includegraphics[scale=0.5]{SolveFull-Mathematica_03} 
 \end{figure}
The result is acceptable specially referring to the fact that we are using wrong $\Phi$ and $\Phi'$ in the mathematica!\\
Just to check that everything is consistent we run Gevolution but instead of comparing the results at z=10 we compare at  higher redshifts which we think our approximation ($\Phi''\approx 0$) works better. Now we compare the results at z=80 from initial condition at z=100,\\
{\Large{{\color{red}Bug }}}:{\color{red}  Up to now we have made a mistake on providing $\Phi'$, since at initial redshift it is zero! So we made a mistake on all comparisons with $\Phi'$ since it was taken exactly zero!}
To fix this, we provide $\Phi'$ from redshift like z=90which is non-zero!\\
{\color{blue}{\Large{Important point}}: Since we are providing the initial condition for mathematica from the power of variables so it does not care about the sign!!! If we take the output of $\Phi$ and $\Phi'$ from Gevolution we see that both change sign during redshift and depending on the position on the lattice!!! But is it the same in Fourier space? Not necessarily! in Fourier space $\Phi$ is positive and $\Phi'$ is negative according to our observation from Class output!    }
Also we observe that if we set $\Phi'=0$ in mathematica we make less mistake than when we use the positive value at initial redshift! It seems somehow complicated to capture the sign which is removed by computing power!\\ The way to read the sign of $\Phi(x)$ and $\Phi'(x)$ is as following in Gevolution,
    \begin{lstlisting}[language=c++, basicstyle=\tiny]
        for (x.first(); x.test(); x.next())
    		{
    			phi_prime(x) =(phi(x)-phi_old(x))/(dtau);
          if(x.coord(0)==2  && x.coord(2)==1)
          {
            if(parallel.isRoot())
            {
              cout<<"Phi_prime: "<<phi_prime(x)<<"Phi: "<<phi(x)<<endl;
            }
          }
    		}
 \end{lstlisting}
 We must provide the field transfer function as an output which seems very important for tracing small errors! We need it because we are solving different equation in mathematica and Gevolution since providing initial condition from power removes the sign of the field!\\ In parallel we can believe our comparison, because of the fact that the relative error is small and also we just have added the potentials which we believe are true in Gevolution! So the final comparison which is really important is Class versus Gevolution and we use mathematica just for checking the numerical approximations and if in principle it is true.\\
 But as already mentioned we can find the sign of variables, if they don't change sign and in this case we do not have problem dealing with setting initial condition in mathematica!\\
 According to the fact $\Phi$ is positive in Fourier space and $\Phi'$ is negative (the potential decays) in high redshifts we set the correspondent initial condition with the correct sign in mathematica and try to compare with Gevolution,\\
 The result when we provide the initial condition for the $\Phi$ at z=100 and $\Phi'$ at z=98 for taking positive, negative or zero is as following,
   \begin{figure}[H]
 \includegraphics[scale=0.5]{comp_phip_negativ} 
 \end{figure}
   \begin{figure}[H]
 \includegraphics[scale=0.5]{comp_phip_positiv} 
 \end{figure}
   \begin{figure}[H]
 \includegraphics[scale=0.5]{comp_phip_0} 
 \end{figure}
 The conclusion from the relative error on $\mathcal{H} \pi$ would be we better take $\Phi'=0$ to take constant at z=95, since in the first case we are also changing $\Phi$ with a constant rate at all redshifts which is not the same as z=95 necessarily! While we improve the relative error on  $\zeta$ by taking the true behaviour for $\Phi'$ which is negative! The reason is not very clear, since these are coupled equations!
  \\ We need to make a better comparison to make sure the one we think is the correct one (negative)?\\
 Just note that when we set $\Phi'$ a constant and the value at z=50 for example instead of also changing $\Phi$ according to $\Phi'=c$, we get better solution which shows that the relative error is not because of making mistake on $\Phi'$ and $\Phi$
    \begin{figure}[H]
 \includegraphics[scale=0.5]{comp_phi_p_03} 
 \end{figure}
 The conclusion after some tests is:\\
 Since we have coupled equations we cannot certainly say what happens if we make $\Phi$ or $\Phi'$ better estimation. But something which is really clear is that although we do not provide the true initial conditions for $\Phi$ and $\Phi'$ and $\Phi''$, since its not possible, but the relative error is really acceptable and is clear which comes from the fact that we could not provide complete differential equations. Moreover we have tested our previous argument by letting $\Phi=\Phi=0$ which we got the right answer in Gevolution and Mathematica. So we do not need to be so sensitive to the decrease the relative error more!! 
 
 
\section{Adding a function for getting field transfer function as the output } 
 Here we try to write a function in output.hpp to print out all the requested field transfer functions in Fourier space into the output text.\\
 This is very important since we want to precisely compare the Gevolution result with Mathematica, while using powerspectrum and extracting trasferfunction from it, does not allow as we have already seen couple of examples which we get wrong results because the field was negative-positive while we take it just positive in mathematica...
 \\
instead of writing a new function we can use the extractCrossSpectrum function in tools.hpp and think of a function which if is crossed with our desired function just gives the Fourier transform of the desired function! It is clear that the other function in real space must be constant (like=1)! So what we do is defining a  new constant function which is just used for calculating the transfer function! To do so, we need to make sure if we have understood the cross powerspectrum function correctly, because if it takes average over wavenumbers when we set one function to a constant we get zero since the average of the fields is zero!\\
The discussion with Julian for the solution is as following,
     \begin{figure}[H]
 \includegraphics[scale=0.5]{Julian_discuss_01_01} 
 \end{figure}
    \begin{figure}[H]
 \includegraphics[scale=0.5]{Julian_discuss_02_02} 
 \end{figure}
     \begin{figure}[H]
 \includegraphics[scale=0.5]{Julian_discuss_03_03} 
 \end{figure}
     \begin{figure}[H]
 \includegraphics[scale=0.5]{Julian_discuss_04_04} 
 \end{figure}

 \subsection{Field dynamics and stress tensor while kessence source gravity}
 Accepting the fact that we are solving the equations correctly, we can turn on kessence source gravity to see the effect of kessence on the total stress tensor is resonable and can we get something? We again provide the initial condition at z=100 except $\Phi'$ which is provided at z=95, and look at the solution of field and stress tensor. The fields relative error would be as following which shows that the backreaction effect from the fields to themselves is negligible, since we get more or less the same plot when it was off!\\
  {\color{red} Note that if we get at z=10 we see a lot of difference because we make a mistake on $\Phi$ and $\Phi'$! So we compare at z=50 }\\
 The comparison at z=50 for when the kessence is turned on and off is as following,
      \begin{figure}[H]
 \includegraphics[scale=0.3]{Field_evolution_001} 
 \end{figure}
     \begin{figure}[H]
 \includegraphics[scale=0.3]{Field_evolution_002} 
 \end{figure}
 As it is clear we do not see any difference on the field behaviour! On the other hand the backreaction from kessence stress tensor to the fields is negligible!\\
 Comparing the $\delta_{kess}$ fro when it sources gravity and when it does not, give the same solution! To make sure we are getting the right solution we need to compare Gevolution $\delta_{kess}$ versus class or some other tests..
  \section{The ratio of $\delta_{kess}$ in Gevolution and total stress tensor compared with class for different $c_s^2$ limits}
  To see the effect of kessence on total stress tensor we measure the $\delta_{kess}/\delta_{tot}$, this is a very good check specially for the limit $c_s^2 \to 0$ which we expect the same behaviour from both! \\
  We now shift to the python and try to compare the plots from class with Gevolution, first we interpolate class data on Gevolution wavenumbers for a better comparison as following in the python,
      \begin{lstlisting}[language=python, basicstyle=\tiny]
  # params for makin power dimensionless
# H_0 in Gevilution unit.
h=0.67556
Boxsize=320.;
c=2997.; #[100km/s]
HGev=np.sqrt(Boxsize**2/c**2) #0.10677, H0 Gevolution in code's unit
def Hubble_conf_Mpc(a):
    H0=0.00022593979933110373;w=-0.9;h=0.67556;
    Omega_b=0.022032/h/h; Omega_cdm=0.12038/h/h;
    Omega_m=Omega_b+Omega_cdm; Omega_Lambda=0.0;
    Omega_rad=9.16681e-05; Omega_kessence=1.-Omega_m-Omega_rad;
    return H0*np.sqrt(Omega_m*(a**-3)+Omega_rad*(a**-4)+Omega_Lambda+Omega_kessence*(a**(-3*(1+w))))*a
#################################
#Class Hubble factor, H in unit 1/Mpc!
# It is phsyical hubble, to make it conformal need to multiply to a. Hconf = H_phys * a
H_conf_class_z100=Hubble_conf_Mpc(1./(1.+100.)); # Unit=1/Mpc Hconf=a*H
H_conf_class_z10=Hubble_conf_Mpc(1./(1.+10.)); # Unit=1/Mpc Hconf=a*H
H_conf_class_z1=Hubble_conf_Mpc(1./(1.+1.)); # Unit=1/Mpc Hconf=a*H
H_conf_class_z0=Hubble_conf_Mpc(1./(1.+0.)); # Unit=1/Mpc Hconf=a*H
#################################
# Parameters for converting to dimensionless power.
As=2.19*10**-9;
h=0.67556
kp=0.05/h; 
ns=0.96;
cs2=1.e-6;
#################################
#Making power of class field to compare with Gev
Class_power_z100=np.zeros((np.shape(Gev_deltakess_z02)[0],8))
Class_power_z10=np.zeros((np.shape(Gev_deltakess_z02)[0],8))
Class_power_z1=np.zeros((np.shape(Gev_deltakess_z02)[0],8))
Class_power_z0=np.zeros((np.shape(Gev_deltakess_z02)[0],8))
# Making interpolation, for delta!
for i in range (1,7):
    interp_class_100 =interp1d(class_newt_z100[:,0],class_newt_z100[:,i])
    interp_class_10 =interp1d(class_newt_z10[:,0],class_newt_z10[:,i])
    interp_class_1 =interp1d(class_newt_z1[:,0],class_newt_z1[:,i])
    interp_class_0 =interp1d(class_newt_z0[:,0],class_newt_z0[:,i])

    Class_power_z100[:,i]=As*((interp_class_100(Gev_deltakess_z02[:,0]))**2)*((Gev_deltakess_z02[:,0]/kp)**(ns-1.));
    Class_power_z10[:,i]=As*((interp_class_10(Gev_deltakess_z02[:,0]))**2)*((Gev_deltakess_z02[:,0]/kp)**(ns-1.));
    Class_power_z1[:,i]=As*((interp_class_1(Gev_deltakess_z02[:,0]))**2)*((Gev_deltakess_z02[:,0]/kp)**(ns-1.));
    Class_power_z0[:,i]=As*((interp_class_0(Gev_deltakess_z02[:,0]))**2)*((Gev_deltakess_z02[:,0]/kp)**(ns-1.));
        \end{lstlisting}
        After comparison, we get the following result which is completely consistent! Note that the initial condition for $\zeta$ is wrong for some wavenumbers!
             \begin{figure}[H]
 \includegraphics[scale=0.5]{delta_m_kess_001} 
 \end{figure}
 
 {\Large{
 If we multiply to $1+w/(1-3w)$ we get the same plot, \\
 Which also says that when the perturbations get non-linear, since for $w=-0.9$, because $\delta_m$ get non-linear about $z=37$ maybe? and then since $\delta_{kess}$ is suppressed by some factors (1/37), so it gets non-linear below than z=0 and we neve see it. \\
 A good check: If multiply $\delta_k$ to $(1+w/(1-3w))$ we get the same behaviour which is consisten.
\\
So maybe check for some lower w, lwhich clusters better and sooner.
 
 }}
        
\subsection{Comparing class  and Gevolution with initial condition from class {\color{red} Must be completed for more redshift ranges and also big runs!}   {(\color{red} TODO:)}  }
Giving initial condition from Class, comparing Class with mathematica at redshift z=10 gives the following result which shows full agreement, Note that the initial condition of class and Gevolution are slightly different
             \begin{figure}[H]
 \includegraphics[scale=0.5]{fields_class_Gev} 
 \end{figure}
{\color{red} Question: why we get less power at high wavenumbers in Gevolution than Class? Nyqvist frequency?}
{Martin: This is a good check, also if we have matter kessence instead of just matter we dont have shell crossing and we may get Black hole?!}
\subsection{Checking the limit $c_s^2 \to 0$ that we get kessence density as matter density  {(\color{red} TODO:)} }
-For the limit $c_s^2 \to 0$ and $w \to 0$ check we get matter power from Gevolution compared with class!\\
We have checked that we get such a behaviour in class, do we get in Gevolution too? For not very small $c_s^2$ yes, but it is also a good check to see this in smaller sound speeds.
This is a consistency check but not so much necessary for our purposes!
\begin{figure}[H]
 \includegraphics[scale=0.5]{class} 
 \end{figure}
%\section{Non-linear contrubution}
%Here we write the full equations and try to solve them numerically in Gevolution, and if we got something intreesting or strange we need to solve them in mathematica to see if we did not have make a mistake ! \\
%To solve in mathematica we must solve with Non -linear solve command and to exactly compare with Gevolution we can get some symmetric situations. The discussion with Julian is as following,
%          \begin{figure}[H]
% \includegraphics[scale=0.5]{Julina_NL_001} 
% \end{figure}
%           \begin{figure}[H]
% \includegraphics[scale=0.5]{Julian_NL_002} 
% \end{figure}
%\section{Sensitivity to initial conditions}
%What would be error if we set the initial condition at z=100 to zero?
% \flushbottom
% \section{The effect of non linearities on gravitational potential at some different redshifts $\Psi$ and matter power spectrum}
%\section{Trace the average of the perturbation to be consistent}
%\section{Vector elliptic and vector parabolic consistency check}
%{\color{red} If we use pureEFT flag in EFTcamb, what are the related parameters for k-essence case?  since the translation between the standard language with EFTcamb is not trivial according to table 1 of   \url{https://arxiv.org/pdf/1411.3712.pdf} }
%In the beginning we use minimally coupled quintessence flag in the EFTcamb to check the consistency, then we should try the pureEFT flag. We choose the quintessence flag according to \url{http://www.eftcamb.org/images/EFTCAMB_structure.pdf} in the second part.

 